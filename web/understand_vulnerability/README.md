# WEBサービスの代表的な脆弱性を理解する

## 課題1(質問)

### 脆弱性の仕組み、発生し得る被害、対処法を解説してください

#### XSS(クロスサイトスクリプティング)

仕組み: 悪意のあるスクリプトをWebページに注入し、ユーザーのブラウザでそのスクリプトが実行される脆弱性です。

発生し得る被害
1. 本物サイト上に偽のページが表示される
    - 偽情報の流布による混乱
    - フィッシング詐欺による重要情報の漏えい
2. ブラウザが保存しているCookieを取得される
    - Cookie にセッションIDが格納されている場合、さらに利用者へのなりすましにつながる
    - Cookie に個人情報等が格納されている場合、その情報が漏えいする

3. 任意のCookieをブラウザに保存させられる
    -  セッションIDが利用者に送り込まれ、「セッションIDの固定化」 攻撃に悪用される
    
参考文献: [安全なウェブサイトの作り方 - 1.5 クロスサイト・スクリプティング](https://www.ipa.go.jp/security/vuln/websecurity/cross-site-scripting.html)

対策: 
1. 入力データのエスケープ: ユーザーからの入力データを表示する際にはHTMLエスケープする
2. コンテンツセキュリティポリシー（CSP）の設定: 悪意のあるスクリプトの実行を防ぐためにCSPを設定する。
3. JavaScriptやHTMLのサニタイズ: サニタイズライブラリを使用して、ユーザーからの入力を適切にフィルタリングする。

#### コマンドインジェクション

仕組み: 攻撃者がアプリケーションを介してシステムコマンドを実行する脆弱性です。

発生し得る被害:
1. サーバ内ファイルの閲覧、改ざん、削除(重要情報の漏えい、設定ファイルの改ざん)
2. 不正なシステム操作(意図しないOS のシャットダウン、ユーザアカウントの追加、変更)
3. 不正なプログラムのダウンロード、実行(ウイルス、ワーム、ボット等への感染、バックドアの設置)
4. 他のシステムへの攻撃の踏み台(サービス不能攻撃、システム攻略のための調査、迷惑メールの送信 )

対策:
1. ユーザー入力のバリデーション 
    -  ユーザー入力を適切にフィルタリングして、シェルメタキャラクターや不正なコマンドを排除する。
2. 安全なコマンド実行方法の使用
    -  exec() や system() のような危険な関数の使用を避け、可能であれば高レベルAPIを使用する。
3. 最小権限の原則
    - サーバーやプロセスに最小限の権限を与えておくことで、万が一侵入された場合の被害を最小限にする。

参考文献: [安全なウェブサイトの作り方 - 1.2 OSコマンド・インジェクション](https://www.ipa.go.jp/security/vuln/websecurity/os-command.html)

#### SQLインジェクション

仕組み: アプリケーションがユーザー入力を直接SQLクエリに組み込む際に、攻撃者が悪意のあるSQLコードを注入することで発生します。これにより、攻撃者はデータベースに対して不正な操作を実行することが可能になります。

発生し得る被害:
1. データ漏洩
    - データベース内の敏感な情報（顧客データ、機密データなど）が攻撃者によって不正に取得される可能性があります。
2. データの改ざん
    - 攻撃者はデータベース内のデータを変更したり削除したりすることができます。
3. 認証バイパス
    - 攻撃者はログイン認証をバイパスして、他のユーザーや管理者として不正にログインできる可能性があります。
4. データベース破壊
    - 攻撃者はデータベースの構造そのものを破壊したり、データベース全体を削除したりする可能性があります。
5. 他のシステムへの攻撃
    - データベースサーバーを経由して、ネットワーク内の他のシステムに攻撃を広げる可能性もあります。
    
対策:
1. パラメータ化クエリの使用
    - ユーザー入力を直接クエリに埋め込まず、パラメータ化されたクエリやプリペアドステートメントを使用します。 
2. 入力データのサニタイズ
3. 最小権限の原則
    - データベースユーザーに最小限の権限しか付与しない。 

参考文献: [安全なウェブサイトの作り方 - 1.1 SQLインジェクション](https://www.ipa.go.jp/security/vuln/websecurity/sql.html)

#### CSRF
仕組み: ユーザーが意図しないリクエストを別のウェブサイトに対して送信するように攻撃者が誘導する脆弱性です

発生し得る被害:
1. ログイン後の利用者のみが利用可能なサービスの悪用
    - 不正な送金、利用者が意図しない商品購入、利用者が意図しない退会処理
2. ログイン後の利用者のみが編集可能な情報の改ざん、新規登録
    - 各種設定の不正な変更（管理者画面、パスワード等）、掲示板への不適切な書き込み

対策:
1. CSRFトークンの導入
    - 各リクエストに対して一意のトークンを生成し、これをフォームデータやリクエストヘッダーに含めることで、リクエストが正規のものであることを確認します。 
2. SameSite属性の使用
3. Refererヘッダーのチェック

    
参考文献: [安全なウェブサイトの作り方 - 1.6 CSRF（クロスサイト・リクエスト・フォージェリ](https://www.ipa.go.jp/security/vuln/websecurity/csrf.html)


### 先輩エンジニアから「正規表現エンジンに負荷がかからないか検討した？」と聞かれました。

1. 正規表現のパフォーマンス問題
   - 複雑な正規表現や特定のパターンは入力に対して時間がかかることがあります。
2. ReDoS（正規表現によるサービス拒否攻撃）
- 攻撃者によって意図的に作られた入力データによって極端に時間がかかる可能性があります。
- APIに対する負荷を増加させ全体的なパフォーマンスの低下を引き起こす可能性があります。

## 課題2(クイズ)
1. あるWebアプリケーションで、ユーザーの入力をページに表示する際に、エスケープ処理を行っていないとします。このとき、攻撃者がどのような入力を行うことでXSS攻撃が成立する可能性が最も高いでしょうか？
    1. `<img src="invalid.jpg" onerror="alert('XSS')">`
    2. `SELECT * FROM users WHERE id=1`
    3. `../../etc/passwd`
    4. `&lt;script&gt;alert(1)&lt;/script&gt;`

    正解: `<img src="invalid.jpg" onerror="alert('XSS')">`


2. ユーザーがフォームに入力したデータを使ってシェルコマンドを実行する機能があります。このとき、どのような入力がコマンドインジェクション攻撃を引き起こす可能性が高いでしょうか？

    1. `&& rm -rf /`
    2. `OR 1=1`
    3. `<script>alert('XSS')</script>`
    4. `../../../../../etc/passwd`

    正解: `&& rm -rf /`