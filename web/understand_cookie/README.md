## クッキーを理解する

### 課題 1 (質問)

```
クッキーとは何でしょうか？「Set-cookie」「ヘッダ」「サーバ」「ブラウザ」という単語を使って、クッキーの仕組みを説明してみてください

解答: ブラウザへ対してサーバがレスポンスを送信するときに`Set-Cookie`ヘッダーを設定することで小さなデータをブラウザに保存させることができる。CookieはステートレスなHTTPプロトコルのためにステートフルな情報を記憶する。
```

```
www.hoge.comで発行されたクッキーは、www.fuga.comにも送信されるでしょうか？その理由を説明してください

解答: Domain=fuga.comと指定すれば可能。これはクッキーを送信する先のホストを定義することができる。指定されなかった場合は、この属性は規定で現在の文書のURLにおけるホスト名の部分になり、サブドメインを含まない。複数のホストやドメインの値を指定することはできないが、ドメインが指定された場合、全てのサブドメインが常に含まれます。
```

```
hoge.com:8080のクッキーはhoge.com:9090にも送信されるでしょうか？

解答: クッキーはドメインが同じであればポート番号に関係なく送信させれる。
RFC6265: Similarly, cookies for a given host are shared across all the ports on that host, even though the usual "same-origin policy" used by web browsers isolates content retrieved via different ports.
```

```
www.hoge.comで発行されたクッキーは、www.api.hoge.comにも送信されるでしょうか？

解答: 指定しないのであれば、Domainは規定上、文章のURLにおけるホスト名部分になり、サブドメインを含まない。
```

```
クッキーにDomain="hoge.com"を指定した場合、api.hoge.comにもクッキーは送信されるでしょうか？理由を説明してください

解答: ホスト名のみの指定の場合、全てのサブドメインが対象になります。
```

```
ブラウザで実行されるJavaScriptは場合によってはクッキーの値を取得できます。JavaScriptからクッキーの値が取得されることを防ぐことは可能でしょうか？どうすれば良いのでしょうか？

解答: HttpOnlyを指定することで、JavascriptがDocument.cookieプロパティなどを介してクッキーにアクセスすることを禁止できます。
```

```
HTTPS（暗号化）通信の時だけクッキーを送信することは可能でしょうか？どうすれば良いのでしょうか？
解答: Secure 属性がついた Cookie は HTTPS プロトコル上の暗号化されたリクエストでのみサーバーに送信され、安全でない HTTP では決して送信されない。
```

```
クッキーにExpiresを設定すると、どのように挙動が変わるでしょうか？

解答: Expiresはクッキーの有効期限を示す、HTTPの日時タイムスタンプです。指定されなかった場合は、クッキーはセッションクッキーの寿命になります。セッションはクライアントが終了したときに終了するので、セッションクッキーはその時点で削除されます。
```

```
SameSite属性について説明してください
解答: クロスサイトリクエストでクッキーを送信するかどうかを制御し、クロスサイトリクエストフォージェリ攻撃 (CSRF) に対するある程度の防御を提供します。

```

```
クッキーに格納しない方が良い情報の例を、3 つ以上挙げてください

解答:
1. 秘匿性の高い情報を格納しない -> パスワード、E メールアドレス、クレジットカード情報など
2. 個人情報(名前、E メール、電話番号など)
3. クッキーは最大約 4KB しか格納できないため、それ以上の大きさのデータは避ける
```

```
クッキーはローカルストレージと混同されることが多々あります。クッキーを使うべきタイミングと、ローカルストレージを使うべきタイミングを挙げてみてください

解答:
LocalStorage：永続的なデータの保存が必要で、異なるタブ間でデータの共有が必要な場合に選択されます。
Cookies：有効期限を設定して永続的なデータの保存と、異なるセッションや異なるドメイン間でデータの共有が必要な場合に選択されます。
```

```
Stack Overflow のような WEB 掲示板サービスを開発しているとしましょう。XSS（クロスサイトスクリプティング）により、他ユーザのクッキー情報が抜き出される仕組みを説明してください。どのような対策が考えられますか？

解答:
1. 脆弱性がある部分を発見し、悪意がある JS スクリプトをコメント、スレッドなどに投稿する
2. 他のユーザーがコンテンツを閲覧することで、このユーザーのブラウザでスクリプトが実行される
3. スクリプトが document.cookie にアクセスしクッキーからセッション情報を取得し、攻撃者のサーバーへ送信される
4. 攻撃者はセッション情報を使い、不正アクセスを行う

対応策:

1. 投稿内容のバリデーションを行う
2. Content-Security-Policy ヘッダーレスポンスに付与し、ユーザーエージェントがロードできるリソースを管理する
3. クッキーで HttpOnly フラグを立て、クッキーへのJS スクリプトからのアクセスされるリスクを軽減する
4. 定期的なセキュリティ監査を実施する
```

### 課題 2 (クイズ)

```
クッキーに関するクイズを作成してください

Path属性について説明してください。
解答: クッキーヘッダーを送信するためにリクエストされたURLの中に含む必要があるURLのパスを示します。

例えばPath=/docs
クッキーを送るリクエストパス
- /docs
- /docs/
- /docs/Web/
- /docs/Web/HTTP

送らないパス
- /
- /docsets
- /fr/docs
```
